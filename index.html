<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تقرير سوق السيدان 2026 - Master Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Tajawal', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .price-input:focus {
            background-color: #eff6ff;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        /* Modal Backdrop */
        .modal-overlay {
            background-color: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <header class="bg-slate-900 text-white shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center gap-2 mb-4 md:mb-0">
                <svg xmlns="http://www.w3.org/2000/svg" class="text-blue-400 w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><path d="M9 17h6"/><circle cx="17" cy="17" r="2"/></svg>
                <div>
                    <h1 class="text-xl font-bold">تقرير سوق السيارات 2026</h1>
                    <p class="text-xs text-slate-400">حفظ تلقائي للمقدم والأسعار</p>
                </div>
            </div>
            
            <nav class="flex gap-2" id="nav-tabs">
                <button data-tab="table" class="nav-btn px-4 py-2 rounded-lg transition-colors bg-blue-600 text-white">الجدول المالي</button>
                <button data-tab="analysis" class="nav-btn px-4 py-2 rounded-lg transition-colors bg-slate-800 hover:bg-slate-700">التحليل الفني</button>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        
        <section class="mb-8 bg-blue-50 p-6 rounded-xl border border-blue-100 shadow-sm sticky top-24 z-30">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-slate-700 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    إعدادات القرض (يتم الحفظ تلقائياً)
                </h2>
                <button id="reset-data-btn" class="text-xs text-red-600 hover:text-red-800 underline">استعادة الافتراضي</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-slate-700 mb-2">المقدم (جنيه مصري)</label>
                    <input type="number" id="down-payment" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none font-bold text-lg text-slate-800">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">سعر الفائدة (%)</label>
                    <div class="relative">
                        <input type="number" id="interest-rate" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none pl-10">
                        <span class="absolute left-3 top-3 text-slate-400 font-bold">%</span>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">تأمين شامل (%)</label>
                    <div class="relative">
                        <input type="number" id="insurance-rate" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none pl-10" placeholder="3">
                        <span class="absolute left-3 top-3 text-slate-400 font-bold">%</span>
                    </div>
                </div>
            </div>
        </section>

        <div id="app-content"></div>

    </main>

    <div id="car-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0" id="modal-backdrop"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto pointer-events-auto animate-fade-in relative flex flex-col">
                <button id="close-modal" class="absolute left-4 top-4 text-slate-400 hover:text-red-500 z-10 p-2 bg-slate-100 rounded-full transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <div id="modal-body" class="p-0"></div>
            </div>
        </div>
    </div>

    <script>
        // --- Data Source ---
        const defaultCars = [
            { id: 4, name: "Hyundai Accent RB", trim: "DAB ABS", price: 815000, model: "أكسنت RB", origin: "محلي", specs: "1.6L - 125hp", pros: "موتور قوي، إعادة بيع، عفشة اعتمادية", cons: "أمان ضعيف (1 Airbag)، استهلاك بنزين، خامات بلاستيك" },
            { id: 5, name: "Geely Emgrand", trim: "Comfort", price: 839000, model: "جيلي إمجراند", origin: "استيراد", specs: "1.5L - 102hp", pros: "تصميم عصري جداً، عزل ممتاز، ثبات", cons: "موتور أداءه متواضع، انتشار قطع الغيار لسه في الأول" },
            { id: 6, name: "BAIC U5 Plus", trim: "Top Line", price: 855000, model: "بايك U5", origin: "استيراد", specs: "1.5L - 111hp", pros: "شاشات وكاميرات 360، مقاعد جلد مريحة", cons: "تحدي إعادة البيع، توفر قطع الغيار" },
            { id: 7, name: "Hyundai Elantra HD", trim: "Highline", price: 890000, model: "إلنترا HD", origin: "محلي", specs: "1.6L - 121hp", pros: "اعتمادية مطلقة، قطع غيار في كل مكان", cons: "تصميم قديم جداً (2007)، فقيرة في الكماليات" },
            { id: 8, name: "Hyundai Elantra AD", trim: "Smart", price: 920000, model: "إلنترا AD", origin: "محلي", specs: "1.6L - 127hp", pros: "شكل رياضي، ثبات ممتاز، صالون واسع", cons: "الفئة الأولى فاضية أوبشنز" },
            { id: 9, name: "MG 5", trim: "Luxury", price: 900000, model: "MG 5", origin: "استيراد", specs: "1.5L - 120hp", pros: "أعلى قيمة مقابل سعر (فتحة سقف، كراسي كهرباء، 6 ايرباج)", cons: "واطية ع الأرض، توكيل عليه ضغط" }
        ];

        // --- App State Management ---
        const AppState = {
            activeTab: 'table',
            interestRate: 15,
            downPayment: 300000,
            insuranceRate: 3, 
            searchTerm: '',
            cars: [],

            init() {
                // 1. Load Cars Data
                const storedCars = localStorage.getItem('carPricesData_v2');
                this.cars = storedCars ? JSON.parse(storedCars) : JSON.parse(JSON.stringify(defaultCars));

                // 2. Load Settings
                const storedSettings = localStorage.getItem('loanSettings');
                if (storedSettings) {
                    const settings = JSON.parse(storedSettings);
                    this.interestRate = settings.interestRate || 15;
                    this.downPayment = settings.downPayment || 300000;
                    this.insuranceRate = settings.insuranceRate || 3;
                }

                this.render();
                this.setupGlobalListeners();
            },

            saveData() {
                localStorage.setItem('carPricesData_v2', JSON.stringify(this.cars));
            },

            saveSettings() {
                const settings = {
                    interestRate: this.interestRate,
                    downPayment: this.downPayment,
                    insuranceRate: this.insuranceRate
                };
                localStorage.setItem('loanSettings', JSON.stringify(settings));
            },

            resetData() {
                if(confirm('هل أنت متأكد من استعادة الأسعار والإعدادات الافتراضية؟')) {
                    localStorage.removeItem('carPricesData_v2');
                    localStorage.removeItem('loanSettings');
                    location.reload();
                }
            },

            updatePrice(id, newPrice) {
                const carIndex = this.cars.findIndex(c => c.id === parseInt(id));
                if (carIndex !== -1) {
                    this.cars[carIndex].price = parseInt(newPrice) || 0;
                    this.saveData();
                    this.renderContent(); 
                }
            },

            calculateLoan(price, years) {
                const remainder = price - this.downPayment;
                if (remainder <= 0) return { installment: 0, remainder: 0, totalInterest: 0, totalAmount: 0 };
                
                // Flat Rate Formula
                const totalInterest = remainder * (this.interestRate / 100) * years;
                const totalAmount = remainder + totalInterest;
                const monthlyInstallment = totalAmount / (years * 12);
                
                return {
                    remainder: remainder,
                    installment: Math.round(monthlyInstallment),
                    totalInterest: Math.round(totalInterest),
                    totalAmount: Math.round(totalAmount)
                };
            },

            getDetailedCash(price) {
                const loanAmount = price - this.downPayment;
                if(loanAmount <= 0) return { adminFees: 0, insurance: 0, totalCash: 0 };

                const adminFees = loanAmount * 0.015; // 1.5% مصاريف إدارية
                const insurance = price * (this.insuranceRate / 100); // تأمين السنة الأولى
                const totalCash = this.downPayment + adminFees + insurance;

                return {
                    adminFees: Math.round(adminFees),
                    insurance: Math.round(insurance),
                    totalCash: Math.round(totalCash)
                };
            },

            // --- Rendering Logic ---
            render() {
                // Update Inputs
                document.getElementById('interest-rate').value = this.interestRate;
                document.getElementById('down-payment').value = this.downPayment;
                document.getElementById('insurance-rate').value = this.insuranceRate;
                
                // Update Tabs
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    const isActive = btn.dataset.tab === this.activeTab;
                    btn.className = `nav-btn px-4 py-2 rounded-lg transition-colors ${isActive ? 'bg-blue-600 text-white' : 'bg-slate-800 hover:bg-slate-700'}`;
                });

                this.renderContent();
            },

            renderContent() {
                const container = document.getElementById('app-content');
                if (this.activeTab === 'table') {
                    container.innerHTML = this.getTableView();
                    this.attachTableListeners();
                } else {
                    container.innerHTML = this.getAnalysisView();
                }
            },

            // --- Table View ---
            getTableView() {
                const filteredCars = this.cars.filter(car => 
                    car.name.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                    car.model.includes(this.searchTerm)
                );

                let rows = filteredCars.map(car => {
                    const loan2 = this.calculateLoan(car.price, 2);
                    const loan3 = this.calculateLoan(car.price, 3);
                    const loan5 = this.calculateLoan(car.price, 5);
                    const loan7 = this.calculateLoan(car.price, 7);

                    const total2 = loan2.installment > 0 ? (loan2.installment * 24) + this.downPayment : 0;
                    const total3 = loan3.installment > 0 ? (loan3.installment * 36) + this.downPayment : 0;
                    const total5 = loan5.installment > 0 ? (loan5.installment * 60) + this.downPayment : 0;
                    const total7 = loan7.installment > 0 ? (loan7.installment * 84) + this.downPayment : 0;
                    
                    return `
                        <tr class="hover:bg-blue-50 transition-colors cursor-pointer car-row group" data-car-id="${car.id}">
                            <td class="p-4 font-bold text-slate-800 border-b">
                                ${car.name}
                                <div class="text-xs text-slate-400 font-normal mt-1">${car.model}</div>
                            </td>
                            <td class="p-4 text-slate-600 text-sm border-b">${car.trim}</td>
                            <td class="p-4 border-b bg-yellow-50 relative z-10">
                                <div class="flex items-center gap-1">
                                    <input type="number" 
                                           data-id="${car.id}" 
                                           value="${car.price}" 
                                           class="price-input w-24 p-1 text-sm font-mono font-bold text-slate-900 bg-white border border-slate-300 rounded focus:outline-none z-20"
                                    />
                                    <span class="text-xs text-slate-500">ج.م</span>
                                </div>
                            </td>
                            <td class="p-4 font-mono text-slate-600 bg-slate-100 border-b text-center">
                                ${loan5.remainder > 0 ? loan5.remainder.toLocaleString() : 0}
                            </td>
                            
                            <td class="p-2 text-center border-b font-mono text-blue-600 hidden md:table-cell">
                                <div class="font-bold text-lg">${loan2.installment.toLocaleString()}</div>
                                <div class="text-[10px] text-slate-400 mt-1 border-t border-slate-100 pt-1">
                                    إجمالي: ${total2.toLocaleString()}
                                </div>
                            </td>

                            <td class="p-2 text-center border-b font-mono text-emerald-600 bg-emerald-50">
                                <div class="font-bold text-lg">${loan3.installment.toLocaleString()}</div>
                                <div class="text-[10px] text-emerald-600/70 mt-1 border-t border-emerald-100/50 pt-1">
                                    إجمالي: ${total3.toLocaleString()}
                                </div>
                            </td>

                            <td class="p-2 text-center border-b font-mono text-blue-600">
                                <div class="font-bold text-lg">${loan5.installment.toLocaleString()}</div>
                                <div class="text-[10px] text-slate-400 mt-1 border-t border-slate-100 pt-1">
                                    إجمالي: ${total5.toLocaleString()}
                                </div>
                            </td>

                            <td class="p-2 text-center border-b font-mono text-emerald-600 bg-emerald-50 hidden md:table-cell">
                                <div class="font-bold text-lg">${loan7.installment.toLocaleString()}</div>
                                <div class="text-[10px] text-emerald-600/70 mt-1 border-t border-emerald-100/50 pt-1">
                                    إجمالي: ${total7.toLocaleString()}
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');

                return `
                    <div class="animate-fade-in">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-slate-800 mb-2 md:mb-0">اضغط على أي صف للتفاصيل الكاملة</h3>
                            <div class="relative w-full md:w-64">
                                <input type="text" id="search-input" value="${this.searchTerm}" placeholder="ابحث..." class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                        </div>
                        <div class="overflow-x-auto bg-white rounded-xl shadow-lg border border-slate-200">
                            <table class="w-full min-w-[1000px] border-collapse">
                                <thead class="bg-slate-800 text-white">
                                    <tr>
                                        <th class="p-4 text-right">السيارة</th>
                                        <th class="p-4 text-right">الفئة</th>
                                        <th class="p-4 text-right w-40 bg-slate-700 border-b-4 border-yellow-500">السعر</th>
                                        <th class="p-4 text-center bg-slate-700">المتبقي</th>
                                        <th class="p-4 text-center bg-blue-900 hidden md:table-cell">2 سنة</th>
                                        <th class="p-4 text-center bg-emerald-900">3 سنين</th>
                                        <th class="p-4 text-center bg-blue-900">5 سنين</th>
                                        <th class="p-4 text-center bg-emerald-900 hidden md:table-cell">7 سنين</th>
                                    </tr>
                                </thead>
                                <tbody>${rows}</tbody>
                            </table>
                        </div>
                    </div>
                `;
            },

            // --- Analysis View ---
            getAnalysisView() {
                return `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade-in">
                    ${this.cars.map(car => `
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-md transition-shadow flex flex-col">
                            <div class="bg-slate-100 p-4 border-b border-slate-200 flex justify-between items-center">
                                <h3 class="font-bold text-lg text-slate-800">${car.model}</h3>
                                <span class="text-sm font-mono bg-white px-2 py-1 rounded border">${car.price.toLocaleString()}</span>
                            </div>
                            <div class="p-5 flex-grow space-y-4">
                                <div class="text-sm text-slate-600">
                                    <p><span class="font-bold">المواصفات:</span> ${car.specs}</p>
                                    <p><span class="font-bold">المنشأ:</span> ${car.origin}</p>
                                </div>
                                <div class="bg-green-50 p-3 rounded-lg text-sm text-green-800">
                                    <strong>✅ مميزات:</strong> ${car.pros}
                                </div>
                                <div class="bg-red-50 p-3 rounded-lg text-sm text-red-800">
                                    <strong>⚠️ عيوب:</strong> ${car.cons}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>`;
            },

            // --- Modal Logic (The Full Update) ---
            openCarModal(carId) {
                const car = this.cars.find(c => c.id === parseInt(carId));
                if (!car) return;

                const cashDetails = this.getDetailedCash(car.price);
                
                // Installment Cards Generation
                const years = [2, 3, 5, 7];
                let installmentsHTML = '';
                
                years.forEach(year => {
                    const loan = this.calculateLoan(car.price, year);
                    const months = year * 12;
                    // Grand Total Price (Down Payment + Total Loan Amount)
                    const grandTotal = this.downPayment + loan.totalAmount; 
                    // Total Interest Percentage
                    const totalInterestPercentage = (this.interestRate * year).toFixed(0);

                    installmentsHTML += `
                        <div class="bg-white border border-slate-200 rounded-xl p-4 hover:border-blue-300 transition-colors shadow-sm flex flex-col justify-between h-full">
                            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                                <span class="font-bold text-slate-800 text-lg">${year} سنوات</span>
                                <span class="bg-slate-100 text-slate-600 text-xs px-2 py-1 rounded-full font-mono">${months} قسط</span>
                            </div>
                            
                            <div class="space-y-3">
                                <div class="flex justify-between items-end">
                                    <span class="text-slate-500 text-sm font-medium">القسط الشهري</span>
                                    <span class="font-bold text-blue-700 text-xl font-mono">${loan.installment.toLocaleString()} <span class="text-xs font-normal text-slate-400">ج.م</span></span>
                                </div>

                                <div class="bg-red-50 p-2 rounded border border-red-100">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-xs text-red-600 font-bold">إجمالي الفائدة (${totalInterestPercentage}%)</span>
                                        <span class="font-mono font-bold text-red-700 text-sm">${loan.totalInterest.toLocaleString()} ج.م</span>
                                    </div>
                                    <div class="text-[10px] text-red-400 text-right">
                                        (نسبة ${this.interestRate}% × ${year} سنوات)
                                    </div>
                                </div>

                                <div class="flex justify-between items-center bg-slate-50 p-2 rounded border border-slate-200">
                                    <div class="flex flex-col">
                                        <span class="text-xs text-slate-700 font-bold">إجمالي ثمن السيارة</span>
                                        <span class="text-[10px] text-slate-400">(مقدم + أقساط + فايدة)</span>
                                    </div>
                                    <span class="font-mono font-bold text-slate-900">${grandTotal.toLocaleString()} ج.م</span>
                                </div>
                            </div>
                        </div>
                    `;
                });

                const modalHTML = `
                    <div class="bg-slate-900 text-white p-6 rounded-t-2xl sticky top-0 z-50 shadow-md">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="text-2xl font-bold">${car.name}</h2>
                                <p class="text-slate-300 text-sm mt-1">${car.model} - ${car.trim}</p>
                            </div>
                            <div class="text-left">
                                <span class="block text-xs text-slate-400">سعر الكاش الرسمي</span>
                                <span class="font-mono font-bold text-xl text-yellow-400">${car.price.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6 bg-slate-50">
                        
                        <div class="bg-white p-5 rounded-xl border border-blue-100 shadow-sm mb-6">
                            <h3 class="font-bold text-blue-800 mb-4 flex items-center gap-2 border-b pb-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                1. إجمالي الكاش المطلوب الآن
                            </h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-slate-700 mb-2">
                                <div>
                                    <span class="block text-xs text-slate-500">المقدم</span>
                                    <span class="font-mono font-bold text-lg">${this.downPayment.toLocaleString()}</span>
                                </div>
                                <div>
                                    <span class="block text-xs text-slate-500">مصاريف (1.5%)</span>
                                    <span class="font-mono font-bold">${cashDetails.adminFees.toLocaleString()}</span>
                                </div>
                                <div>
                                    <span class="block text-xs text-slate-500">تأمين (${this.insuranceRate}%)</span>
                                    <span class="font-mono font-bold">${cashDetails.insurance.toLocaleString()}</span>
                                </div>
                                <div class="bg-blue-50 p-2 rounded border border-blue-200">
                                    <span class="block text-xs text-blue-600 font-bold">تدفع حالاً</span>
                                    <span class="font-mono font-bold text-blue-800 text-lg">${cashDetails.totalCash.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>

                        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 01-2 2h2a2 2 0 012 2zm0 0h2a2 2 0 012 2v6a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                            2. خطط التقسيط بالتفصيل
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                            ${installmentsHTML}
                        </div>

                        <div class="border-t border-slate-200 pt-6">
                            <h3 class="font-bold text-slate-800 mb-4">3. تفاصيل السيارة</h3>
                            <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                                <div class="bg-white p-3 rounded border">
                                    <span class="block text-slate-400 text-xs">المواصفات</span>
                                    <span class="font-bold text-slate-800">${car.specs}</span>
                                </div>
                                <div class="bg-white p-3 rounded border">
                                    <span class="block text-slate-400 text-xs">المنشأ</span>
                                    <span class="font-bold text-slate-800">${car.origin}</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-green-50 p-4 rounded-lg border border-green-100">
                                    <h4 class="font-bold text-green-800 mb-2 text-sm">المميزات</h4>
                                    <p class="text-sm text-green-700 leading-relaxed">${car.pros}</p>
                                </div>
                                <div class="bg-red-50 p-4 rounded-lg border border-red-100">
                                    <h4 class="font-bold text-red-800 mb-2 text-sm">العيوب</h4>
                                    <p class="text-sm text-red-700 leading-relaxed">${car.cons}</p>
                                </div>
                            </div>
                        </div>

                    </div>
                `;

                document.getElementById('modal-body').innerHTML = modalHTML;
                document.getElementById('car-modal').classList.remove('hidden');
            },

            closeModal() {
                document.getElementById('car-modal').classList.add('hidden');
            },

            // --- Event Listeners ---
            setupGlobalListeners() {
                const handleSettingChange = (key, val) => {
                    this[key] = parseFloat(val) || 0;
                    this.saveSettings();
                    this.renderContent();
                };

                document.getElementById('interest-rate').addEventListener('input', (e) => handleSettingChange('interestRate', e.target.value));
                document.getElementById('down-payment').addEventListener('input', (e) => handleSettingChange('downPayment', e.target.value));
                document.getElementById('insurance-rate').addEventListener('input', (e) => handleSettingChange('insuranceRate', e.target.value));

                document.getElementById('nav-tabs').addEventListener('click', (e) => {
                    if (e.target.classList.contains('nav-btn')) {
                        this.activeTab = e.target.dataset.tab;
                        this.render();
                    }
                });

                document.getElementById('reset-data-btn').addEventListener('click', () => this.resetData());
                
                // Modal Close Logic
                document.getElementById('close-modal').addEventListener('click', () => this.closeModal());
                document.getElementById('modal-backdrop').addEventListener('click', () => this.closeModal());
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') this.closeModal();
                });
            },

            attachTableListeners() {
                // Search Listener
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        this.searchTerm = e.target.value;
                        this.renderContent();
                        const newRef = document.getElementById('search-input');
                        newRef.focus();
                        newRef.setSelectionRange(newRef.value.length, newRef.value.length);
                    });
                }

                // Table Interactions
                const tableBody = document.querySelector('tbody');
                if(tableBody) {
                    // Click Row -> Open Modal
                    tableBody.addEventListener('click', (e) => {
                        if (e.target.tagName === 'INPUT') return; // Ignore input clicks
                        const row = e.target.closest('tr');
                        if (row && row.dataset.carId) {
                            this.openCarModal(row.dataset.carId);
                        }
                    });

                    // Input Edit (Debounced)
                    let typingTimer;
                    tableBody.addEventListener('input', (e) => {
                        if(e.target.classList.contains('price-input')) {
                            const id = e.target.dataset.id;
                            const val = e.target.value;
                            clearTimeout(typingTimer);
                            typingTimer = setTimeout(() => {
                                this.updatePrice(id, val);
                                const newRef = document.querySelector(`input[data-id="${id}"]`);
                                if(newRef) newRef.focus();
                            }, 500);
                        }
                    });
                }
            }
        };

        // Initialize Application
        document.addEventListener('DOMContentLoaded', () => {
            AppState.init();
        });

    </script>
</body>
</html>
